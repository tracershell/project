name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      REGISTRY: docker.io
      IMAGE_NAME: tshelldocker/my-cicd-demo

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Debug workspace
        run: |
          ls -R .
          echo "--- nginx ë””ë ‰í„°ë¦¬ ---"
          ls -al nginx

      - name: ğŸ³ Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ“¦ Build production images
        run: |
          docker build -f client/Dockerfile.prod -t $REGISTRY/$IMAGE_NAME:client-latest .
          docker build -f server/Dockerfile.prod -t $REGISTRY/$IMAGE_NAME:server-latest ./server

      - name: ğŸš€ Push images to DockerHub
        run: |
          docker push $REGISTRY/$IMAGE_NAME:client-latest
          docker push $REGISTRY/$IMAGE_NAME:server-latest

      - name: ğŸ”‘ Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p 2203 ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ“‚ Create remote nginx dir
        run: |
          ssh -p 2203 ${{ secrets.USERNAME }}@${{ secrets.HOST }} \
            "mkdir -p /home/apple2ne1/project/nginx"

      # â€” ì—¬ê¸°ë¶€í„° ìˆ˜ì •ëœ ë³µì‚¬ ë¡œì§ â€”

      - name: ğŸ“ Copy nginx.conf to temp via scp
        run: |
          scp -P 2203 nginx/nginx.conf \
            ${{ secrets.USERNAME }}@${{ secrets.HOST }}:~/nginx.conf_temp

      - name: ğŸ”§ Move nginx.conf into place (sudo)
        run: |
          ssh -p 2203 ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            sudo mv ~/nginx.conf_temp /home/apple2ne1/project/nginx/nginx.conf
            sudo chown apple2ne1:apple2ne1 /home/apple2ne1/project/nginx/nginx.conf
          EOF

      - name: ğŸ”§ Deploy via SSH
        run: |
          ssh -p 2203 ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            cd /home/apple2ne1/project
            docker-compose pull
            docker-compose up -d
          EOF

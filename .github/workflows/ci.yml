name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      REGISTRY: docker.io
      IMAGE_NAME: tshelldocker/my-cicd-demo  # ë³¸ì¸ì˜ DockerHub ì´ë¯¸ì§€ ê²½ë¡œ

    steps:
      # 1) ì „ì²´ ì»¤ë°‹ ì´ë ¥ í¬í•¨ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) ì›Œí¬ìŠ¤í˜ì´ìŠ¤ êµ¬ì¡° ë””ë²„ê·¸
      - name: ğŸ” Debug workspace
        run: |
          echo "=== repo root ==="
          ls -R .
          echo ""
          echo "=== nginx directory ==="
          ls -al nginx || echo "â†’ nginx í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤"
          echo ""
          echo "=== docker-compose.yml ==="
          ls -al docker-compose.yml || echo "â†’ docker-compose.ymlì´ ì—†ìŠµë‹ˆë‹¤"

      # 3) DockerHub ë¡œê·¸ì¸
      - name: ğŸ³ Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4) Production ì´ë¯¸ì§€ ë¹Œë“œ
      - name: ğŸ“¦ Build production images
        run: |
          docker build -f client/Dockerfile.prod \
            -t $REGISTRY/$IMAGE_NAME:client-latest .
          docker build -f server/Dockerfile.prod \
            -t $REGISTRY/$IMAGE_NAME:server-latest ./server

      # 5) ë¹Œë“œëœ ì´ë¯¸ì§€ Push
      - name: ğŸš€ Push images to DockerHub
        run: |
          docker push $REGISTRY/$IMAGE_NAME:client-latest
          docker push $REGISTRY/$IMAGE_NAME:server-latest

      # 6) SSH í‚¤ ì„¤ì •
      - name: ğŸ”‘ Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p 2203 ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      # 7) ì›ê²© nginx ë””ë ‰í„°ë¦¬ ìƒì„±
      - name: ğŸ“‚ Create remote nginx dir
        run: |
          ssh -p 2203 ${{ secrets.USERNAME }}@${{ secrets.HOST }} \
            "mkdir -p /home/apple2ne1/project/nginx"

      # 8a) docker-compose.yml ë³µì‚¬ (ì ˆëŒ€ ê²½ë¡œ)
      - name: ğŸ“ Copy docker-compose.yml via scp
        run: |
          scp -P 2203 docker-compose.yml \
            ${{ secrets.USERNAME }}@${{ secrets.HOST }}:/home/apple2ne1/project/docker-compose.yml

      # 8b) nginx.conf ë³µì‚¬ (ì ˆëŒ€ ê²½ë¡œë¡œ íŒŒì¼ëª…ê¹Œì§€ ì§€ì •)
      - name: ğŸ“ Copy nginx.conf via scp
        run: |
          scp -P 2203 nginx/nginx.conf \
            ${{ secrets.USERNAME }}@${{ secrets.HOST }}:/home/apple2ne1/project/nginx/nginx.conf

      # 9) SSHë¡œ ì ‘ì†í•´ ì»¨í…Œì´ë„ˆ ê°±ì‹  ë° ì¬ì‹œì‘
      - name: ğŸ”§ Deploy via SSH
        run: |
          ssh -p 2203 ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            cd /home/apple2ne1/project
            docker-compose pull
            docker-compose up -d
          EOF

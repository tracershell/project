name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      REGISTRY: docker.io
      IMAGE_NAME: tshelldocker/my-cicd-demo  # 본인의 DockerHub 이미지 경로

    steps:
      # 1) 전체 커밋 히스토리 포함 체크아웃
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) 워크스페이스 구조 디버그
      - name: 🔍 Debug workspace
        run: |
          echo "=== repo root ==="
          ls -R .
          echo ""
          echo "=== nginx directory ==="
          ls -al nginx || echo "→ nginx 폴더가 없습니다"
          echo ""
          echo "=== docker-compose.yml ==="
          ls -al docker-compose.yml || echo "→ docker-compose.yml이 없습니다"

      # 3) DockerHub 로그인
      - name: 🐳 Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4) Production 이미지 빌드
      - name: 📦 Build production images
        run: |
          docker build -f client/Dockerfile.prod \
            -t $REGISTRY/$IMAGE_NAME:client-latest .
          docker build -f server/Dockerfile.prod \
            -t $REGISTRY/$IMAGE_NAME:server-latest ./server

      # 5) 빌드된 이미지 Push
      - name: 🚀 Push images to DockerHub
        run: |
          docker push $REGISTRY/$IMAGE_NAME:client-latest
          docker push $REGISTRY/$IMAGE_NAME:server-latest

      # 6) SSH 키 설정
      - name: 🔑 Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p 2203 ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      # 7) 원격에 nginx 폴더 생성
      - name: 📂 Create remote nginx directory
        run: |
          ssh -p 2203 ${{ secrets.USERNAME }}@${{ secrets.HOST }} \
            "mkdir -p /home/apple2ne1/project/nginx"

      # 8a) docker-compose.yml 복사
      - name: 📁 Copy docker-compose.yml via scp
        run: |
          scp -P 2203 docker-compose.yml \
            ${{ secrets.USERNAME }}@${{ secrets.HOST }}:/home/apple2ne1/project/

      # 8b) nginx.conf 복사
      - name: 📁 Copy nginx.conf via scp
        run: |
          scp -P 2203 nginx/nginx.conf \
            ${{ secrets.USERNAME }}@${{ secrets.HOST }}:/home/apple2ne1/project/nginx/

      # 9) SSH로 접속해 컨테이너 갱신 및 재시작
      - name: 🔧 Deploy via SSH
        run: |
          ssh -p 2203 ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            cd /home/apple2ne1/project
            docker-compose pull
            docker-compose up -d
          EOF
